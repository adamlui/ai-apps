// ==UserScript==
// @name                ChatGPT Infinity âˆž
// @name:ar             ChatGPT Ø¥Ù†ÙÙŠÙ†ÙŠØªÙŠ âˆž
// @name:bg             ChatGPT Ð‘ÐµÐ·ÐºÑ€Ð°Ð¹Ð½Ð¾ÑÑ‚ âˆž
// @name:bn             à¦šà§à¦¯à¦¾à¦Ÿà¦œà¦¿à¦ªà¦¿à¦Ÿà¦¿ à¦‡à¦¨à¦«à¦¿à¦¨à¦¿à¦Ÿà¦¿ âˆž
// @name:cs             ChatGPT NekoneÄno âˆž
// @name:da             ChatGPT Uendelighed âˆž
// @name:de             ChatGPT Unendlichkeit âˆž
// @name:el             ChatGPT Î†Ï€ÎµÎ¹ÏÎ¿ âˆž
// @name:eo             ChatGPT Senfina âˆž
// @name:es             ChatGPT Infinito âˆž
// @name:fi             ChatGPT Ã„Ã¤rettÃ¶myys âˆž
// @name:fr             ChatGPT Infini âˆž
// @name:fr-CA          ChatGPT Infini âˆž
// @name:gu             àªšà«‡àªŸàªœà«€àªªà«€àªŸà«€ àª…àª¨àª‚àª¤ âˆž
// @name:hi             à¤šà¥ˆà¤Ÿà¤œà¥€à¤ªà¥€à¤Ÿà¥€ à¤…à¤¨à¤‚à¤¤ âˆž
// @name:hu             ChatGPT VÃ©gtelen âˆž
// @name:in             ChatGPT Tak Terhingga âˆž
// @name:it             ChatGPT Infinito âˆž
// @name:iw             ×¦'××˜×’×¤×˜ ××™× ×¡×•×£ âˆž
// @name:ja             ChatGPT ç„¡é™å¤§ âˆž
// @name:ka             ChatGPT áƒ£áƒ¡áƒáƒ¡áƒ˜ âˆž
// @name:kn             à²šà²¾à²Ÿà³à²œà²¿à²ªà²¿à²Ÿà²¿ à²…à²¨à²‚à²¤ âˆž
// @name:ko             ChatGPT ë¬´í•œëŒ€ âˆž
// @name:ku             ChatGPT BÃªdawÃ® âˆž
// @name:ml             à´šà´¾à´±àµà´±àµâ€Œà´œà´¿à´ªà´¿à´Ÿà´¿ à´…à´¨à´¨àµà´¤à´¤à´¯àµà´‚ âˆž
// @name:mr             à¤šà¥…à¤Ÿà¤œà¥€à¤ªà¥€à¤Ÿà¥€ à¤…à¤¨à¤‚à¤¤ âˆž
// @name:ms             ChatGPT Tak Terhingga âˆž
// @name:my             ChatGPT á€¡á€™á€»á€¬á€¸á€€á€¼á€®á€¸ âˆž
// @name:nl             ChatGPT Oneindigheid âˆž
// @name:no             ChatGPT Uendelighet âˆž
// @name:or             à¬šà¬¾à¬Ÿà¬œà¬¿à¬ªà¬¿à¬Ÿà¬¿ à¬…à¬¨à¬¨à­à¬¤ âˆž
// @name:pa             à¨šà©ˆà¨Ÿà¨œà©€à¨ªà©€à¨Ÿà©€ à¨…à¨¨à©°à¨¤ âˆž
// @name:pl             ChatGPT NieskoÅ„czonoÅ›Ä‡ âˆž
// @name:pt             ChatGPT Infinito âˆž
// @name:pt-BR          ChatGPT Infinito âˆž
// @name:ro             ChatGPT Infinit âˆž
// @name:ru             ChatGPT Ð‘ÐµÑÐºÐ¾Ð½ÐµÑ‡Ð½Ð¾ÑÑ‚ÑŒ âˆž
// @name:sk             ChatGPT NekoneÄno âˆž
// @name:sr             ChatGPT Ð‘ÐµÑÐºÐ¾Ð½Ð°Ñ‡Ð½Ð¾ÑÑ‚ âˆž
// @name:ta             à®šà®¾à®Ÿà¯ à®œà®¿à®ªà®¿à®Ÿà®¿ à®®à¯à®´à¯à®®à¯ˆà®¯à®¾à®© âˆž
// @name:th             ChatGPT à¸„à¸§à¸²à¸¡à¹„à¸¡à¹ˆà¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸” âˆž
// @name:tr             ChatGPT Sonsuzluk âˆž
// @name:uk             ChatGPT ÐÐµÑÐºÑ–Ð½Ñ‡ÐµÐ½Ð½Ñ–ÑÑ‚ÑŒ âˆž
// @name:ur             Ú†ÛŒÙ¹ Ø¬ÛŒ Ù¾ÛŒ Ù¹ÛŒ Ø¨Û’ Ø§Ù†ØªÛØ§ âˆž
// @name:vi             ChatGPT VÃ´ Háº¡n âˆž
// @name:zh-CN          ChatGPT æ— é™ âˆž
// @name:zh-HK          ChatGPT ç„¡é™ âˆž
// @name:zh-SG          ChatGPT æ— é™ âˆž
// @name:zh-TW          ChatGPT ç„¡é™ âˆž
// @version             2023.5.23
// @description         Generate endless answers from all-knowing ChatGPT (in any language!)
// @description:ar      Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¥Ø¬Ø§Ø¨Ø§Øª Ù„Ø§ Ø­ØµØ± Ù„Ù‡Ø§ Ù…Ù† ChatGPT Ø§Ù„Ø°ÙŠ ÙŠØ¹Ø±Ù Ø§Ù„Ø¬Ù…ÙŠØ¹ (Ø¨Ø£ÙŠ Ù„ØºØ©!)
// @description:bg      Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€Ð°Ð¹Ñ‚Ðµ Ð±ÐµÐ·ÐºÑ€Ð°Ð¹Ð½Ð¸ Ð¾Ñ‚Ð³Ð¾Ð²Ð¾Ñ€Ð¸ Ð¾Ñ‚ Ð²ÑÐµÐ·Ð½Ð°ÐµÑ‰Ð¸Ñ ChatGPT (Ð½Ð° Ð²ÑÐµÐºÐ¸ ÐµÐ·Ð¸Ðº!)
// @description:bn      à¦¸à¦°à§à¦¬à¦œà¦¨à¦¬à¦¿à¦¦à¦¿à¦¤ ChatGPT à¦¥à§‡à¦•à§‡ à¦…à¦¬à¦¿à¦°à¦¾à¦® à¦‰à¦¤à§à¦¤à¦° à¦¤à§ˆà¦°à¦¿ à¦•à¦°à§à¦¨ (à¦¯à§‡à¦•à§‹à¦¨ à¦­à¦¾à¦·à¦¾à¦¯à¦¼!)
// @description:cs      Generujte nekoneÄnÃ© odpovÄ›di ze vÅ¡evÄ›doucÃ­ho ChatGPT (v jakÃ©mkoli jazyce!)
// @description:da      Generer endelÃ¸se svar fra alvidende ChatGPT (pÃ¥ ethvert sprog!)
// @description:de      Generieren Sie endlose Antworten aus dem allwissenden ChatGPT (in jeder Sprache!)
// @description:el      Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÏ„Îµ Î±Ï„ÎµÎ»ÎµÎ¯Ï‰Ï„ÎµÏ‚ Î±Ï€Î±Î½Ï„Î®ÏƒÎµÎ¹Ï‚ Î±Ï€ÏŒ Ï„Î¿ Ï€Î±Î½Ï„Î¿Î³Î½ÏŽÏƒÏ„Î· ChatGPT (ÏƒÎµ Î¿Ï€Î¿Î¹Î±Î´Î®Ï€Î¿Ï„Îµ Î³Î»ÏŽÏƒÏƒÎ±!)
// @description:eo      Generu senfinajn respondojn de Ä‰ioscia ChatGPT (en iu ajn lingvo!)
// @description:es      Genera infinitas respuestas desde ChatGPT que todo lo sabe (Â¡en cualquier idioma!)
// @description:fi      Luo loputtomasti vastauksia kaikkitietÃ¤vÃ¤stÃ¤ ChatGPT:stÃ¤ (millÃ¤ tahansa kielellÃ¤!)
// @description:fr      GÃ©nÃ©rez des rÃ©ponses sans fin Ã  partir de ChatGPT qui sait tout (dans n'importe quelle langue!)
// @description:fr-CA   GÃ©nÃ©rez des rÃ©ponses sans fin Ã  partir de ChatGPT qui sait tout (dans n'importe quelle langue!)
// @description:gu      àª¸àª°à«àªµàªœà«àªžàª¾àª¨à«€ ChatGPT (àª•à«‹àªˆàªªàª£ àª­àª¾àª·àª¾àª®àª¾àª‚!) àª¤àª°àª«àª¥à«€ àª…àª¨àª‚àª¤ àªœàªµàª¾àª¬à«‹ àª¬àª¨àª¾àªµà«‹
// @description:hi      à¤¸à¤­à¥€ à¤œà¤¾à¤¨à¤•à¤¾à¤° ChatGPT à¤¸à¥‡ à¤…à¤‚à¤¤à¤¹à¥€à¤¨ à¤‰à¤¤à¥à¤¤à¤° à¤‰à¤¤à¥à¤ªà¤¨à¥à¤¨ à¤•à¤°à¥‡à¤‚ (à¤•à¤¿à¤¸à¥€ à¤­à¥€ à¤­à¤¾à¤·à¤¾ à¤®à¥‡à¤‚!)
// @description:hu      GenerÃ¡ljon vÃ©gtelen vÃ¡laszokat a mindent tudÃ³ ChatGPT segÃ­tsÃ©gÃ©vel (bÃ¡rmilyen nyelven!)
// @description:in      Hasilkan jawaban tanpa akhir dari ChatGPT yang serba tahu (dalam bahasa apa pun!)
// @description:it      Genera risposte infinite da ChatGPT onnisciente (in qualsiasi lingua!)
// @description:iw      ×”×¤×§ ×ª×©×•×‘×•×ª ××™× ×¡×•×¤×™×•×ª ×ž-ChatGPT ×”×™×•×“×¢ ×”×›×œ (×‘×›×œ ×©×¤×”!)
// @description:ja      ã™ã¹ã¦ã‚’çŸ¥ã£ã¦ã„ã‚‹ ChatGPT ã‹ã‚‰ç„¡é™ã®å›žç­”ã‚’ç”Ÿæˆã—ã¾ã™ (ä»»æ„ã®è¨€èªžã§!)
// @description:ka      áƒ¨áƒ”áƒ¥áƒ›áƒ”áƒœáƒ˜áƒ— áƒ’áƒáƒ£áƒ—áƒáƒ•áƒ”áƒ‘áƒ”áƒšáƒ˜ áƒžáƒáƒ¡áƒ£áƒ®áƒ”áƒ‘áƒ˜ áƒ§áƒáƒ•áƒšáƒ˜áƒ¡áƒ›áƒáƒ›áƒªáƒ•áƒ”áƒšáƒ˜ ChatGPT-áƒ“áƒáƒœ (áƒœáƒ”áƒ‘áƒ˜áƒ¡áƒ›áƒ˜áƒ”áƒ  áƒ”áƒœáƒáƒ–áƒ”!)
// @description:kn      ã™ã¹ã¦ã‚’çŸ¥ã£ã¦ã„ã‚‹ ChatGPT ã‹ã‚‰ç„¡é™ã®å›žç­”ã‚’ç”Ÿæˆã—ã¾ã™ (ä»»æ„ã®è¨€èªžã§!)
// @description:ko      ëª¨ë“  ê²ƒì„ ì•„ëŠ” ChatGPTì—ì„œ ëì—†ëŠ” ë‹µë³€ ìƒì„±(ëª¨ë“  ì–¸ì–´ë¡œ!)
// @description:ku      BersivÃªn bÃªdawÃ® ji ChatGPT-a-zana (bi her zimanÃ®!)
// @description:ml      à´Žà´²àµà´²à´¾à´‚ à´…à´±à´¿à´¯àµà´¨àµà´¨ ChatGPT-àµ½ à´¨à´¿à´¨àµà´¨àµ à´…à´¨à´¨àµà´¤à´®à´¾à´¯ à´‰à´¤àµà´¤à´°à´™àµà´™àµ¾ à´¸àµƒà´·àµà´Ÿà´¿à´•àµà´•àµà´• (à´à´¤àµ à´­à´¾à´·à´¯à´¿à´²àµà´‚!)
// @description:mr      à¤¸à¤°à¥à¤µà¤œà¥à¤žà¤¾à¤¤ ChatGPT (à¤•à¥‹à¤£à¤¤à¥à¤¯à¤¾à¤¹à¥€ à¤­à¤¾à¤·à¥‡à¤¤!) à¤•à¤¡à¥‚à¤¨ à¤…à¤‚à¤¤à¤¹à¥€à¤¨ à¤‰à¤¤à¥à¤¤à¤°à¥‡ à¤µà¥à¤¯à¥à¤¤à¥à¤ªà¤¨à¥à¤¨ à¤•à¤°à¤¾.
// @description:ms      Hasilkan jawapan yang tidak berkesudahan daripada ChatGPT yang serba tahu (dalam mana-mana bahasa!)
// @description:my      á€¡á€¬á€¸á€œá€¯á€¶á€¸á€žá€­á€žá€±á€¬ ChatGPT (á€™á€Šá€ºá€žá€Šá€·á€ºá€˜á€¬á€žá€¬á€…á€€á€¬á€¸á€–á€¼á€„á€·á€ºá€™á€†á€­á€¯) á€™á€¾ á€¡á€†á€¯á€¶á€¸á€™á€²á€·á€¡á€–á€¼á€±á€™á€»á€¬á€¸á€€á€­á€¯ á€–á€”á€ºá€á€®á€¸á€•á€«á‹
// @description:nl      Genereer eindeloze antwoorden van alwetende ChatGPT (in elke taal!)
// @description:no      Generer endelÃ¸se svar fra allvitende ChatGPT (pÃ¥ hvilket som helst sprÃ¥k!)
// @description:or      à¬¸à¬®à¬¸à­à¬¤ à¬œà¬¾à¬£à¬¿à¬¬à¬¾ ChatGPT à¬°à­ à¬…à¬¸à­€à¬® à¬‰à¬¤à­à¬¤à¬° à¬¸à­ƒà¬·à­à¬Ÿà¬¿ à¬•à¬°à¬¨à­à¬¤à­ (à¬¯à­‡à¬• language à¬£à¬¸à¬¿ à¬­à¬¾à¬·à¬¾à¬°à­‡!)
// @description:pa      à¨¸à¨­-à¨œà¨¾à¨£à¨¨ à¨µà¨¾à¨²à©‡ à¨šà©ˆà¨Ÿà¨œà©€à¨ªà©€à¨Ÿà©€ (à¨•à¨¿à¨¸à©‡ à¨µà©€ à¨­à¨¾à¨¸à¨¼à¨¾ à¨µà¨¿à©±à¨š!) à¨¤à©‹à¨‚ à¨¬à©‡à¨…à©°à¨¤ à¨œà¨µà¨¾à¨¬ à¨¤à¨¿à¨†à¨° à¨•à¨°à©‹
// @description:pl      Generuj niekoÅ„czÄ…ce siÄ™ odpowiedzi z wszechwiedzÄ…cego ChatGPT (w dowolnym jÄ™zyku!)
// @description:pt      Gere respostas infinitas do onisciente ChatGPT (em qualquer idioma!)
// @description:pt-BR   Gere respostas infinitas do onisciente ChatGPT (em qualquer idioma!)
// @description:ro      GeneraÈ›i rÄƒspunsuri nesfÃ¢rÈ™ite de la atotÈ™tiutorul ChatGPT (Ã®n orice limbÄƒ!)
// @description:ru      Ð¡Ð¾Ð·Ð´Ð°Ð²Ð°Ð¹Ñ‚Ðµ Ð±ÐµÑÐºÐ¾Ð½ÐµÑ‡Ð½Ñ‹Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹ Ð¾Ñ‚ Ð²ÑÐµÐ·Ð½Ð°ÑŽÑ‰ÐµÐ³Ð¾ ChatGPT (Ð½Ð° Ð»ÑŽÐ±Ð¾Ð¼ ÑÐ·Ñ‹ÐºÐµ!)
// @description:sk      Generujte nekoneÄnÃ© odpovede od vÅ¡evediaceho ChatGPT (v akomkoÄ¾vek jazyku!)
// @description:sr      Ð“ÐµÐ½ÐµÑ€Ð¸ÑˆÐ¸Ñ‚Ðµ Ð±ÐµÑÐºÑ€Ð°Ñ˜Ð½Ðµ Ð¾Ð´Ð³Ð¾Ð²Ð¾Ñ€Ðµ Ð¾Ð´ ÑÐ²ÐµÐ·Ð½Ð°Ñ˜ÑƒÑ›ÐµÐ³ Ð¦Ñ…Ð°Ñ‚Ð“ÐŸÐ¢-Ð° (Ð½Ð° Ð±Ð¸Ð»Ð¾ ÐºÐ¾Ð¼ Ñ˜ÐµÐ·Ð¸ÐºÑƒ!)
// @description:sv      Generera oÃ¤ndliga svar frÃ¥n allvetande ChatGPT (pÃ¥ vilket sprÃ¥k som helst!)
// @description:ta      à®…à®©à¯ˆà®¤à¯à®¤à¯ˆà®¯à¯à®®à¯ à®…à®±à®¿à®¨à¯à®¤ ChatGPT à®‡à®²à®¿à®°à¯à®¨à¯à®¤à¯ à®®à¯à®Ÿà®¿à®µà®±à¯à®± à®ªà®¤à®¿à®²à¯à®•à®³à¯ˆ à®‰à®°à¯à®µà®¾à®•à¯à®•à®µà¯à®®à¯ (à®Žà®¨à¯à®¤ à®®à¯Šà®´à®¿à®¯à®¿à®²à¯à®®à¯!)
// @description:th      à¸ªà¸£à¹‰à¸²à¸‡à¸„à¸³à¸•à¸­à¸šà¹„à¸¡à¹ˆà¸£à¸¹à¹‰à¸ˆà¸šà¸ˆà¸²à¸ ChatGPT à¸—à¸µà¹ˆà¸£à¸­à¸šà¸£à¸¹à¹‰ (à¹ƒà¸™à¸ à¸²à¸©à¸²à¹ƒà¸”à¸à¹‡à¹„à¸”à¹‰!)
// @description:tr      Her ÅŸeyi bilen ChatGPT'den sonsuz cevaplar oluÅŸturun (herhangi bir dilde!)
// @description:uk      Ð“ÐµÐ½ÐµÑ€ÑƒÐ¹Ñ‚Ðµ Ð½ÐµÑÐºÑ–Ð½Ñ‡ÐµÐ½Ð½Ñ– Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ñ– Ð²Ñ–Ð´ Ð²ÑÐµÐ·Ð½Ð°ÑŽÑ‡Ð¾Ð³Ð¾ ChatGPT (Ð±ÑƒÐ´ÑŒ-ÑÐºÐ¾ÑŽ Ð¼Ð¾Ð²Ð¾ÑŽ!)
// @description:ur      ØªÙ…Ø§Ù… Ø¬Ø§Ù†Ù†Û’ ÙˆØ§Ù„Û’ ChatGPT Ø³Û’ Ù„Ø§Ù…ØªÙ†Ø§ÛÛŒ Ø¬ÙˆØ§Ø¨Ø§Øª ØªÛŒØ§Ø± Ú©Ø±ÛŒÚº (Ú©Ø³ÛŒ Ø¨Ú¾ÛŒ Ø²Ø¨Ø§Ù† Ù…ÛŒÚº!)
// @description:vi      Táº¡o vÃ´ sá»‘ cÃ¢u tráº£ lá»i tá»« ChatGPT toÃ n nÄƒng (báº±ng báº¥t ká»³ ngÃ´n ngá»¯ nÃ o!)
// @description:zh-CN   ä»Žæ— æ‰€ä¸çŸ¥çš„ ChatGPT ç”Ÿæˆæ— ç©·æ— å°½çš„ç­”æ¡ˆ (ç”¨ä»»ä½•è¯­è¨€!)
// @description:zh-HK   å¾žç„¡æ‰€ä¸çŸ¥çš„ ChatGPT ç”Ÿæˆç„¡çª®ç„¡ç›¡çš„ç­”æ¡ˆ (ç”¨ä»»ä½•èªžè¨€!)
// @description:zh-SG   ä»Žæ— æ‰€ä¸çŸ¥çš„ ChatGPT ç”Ÿæˆæ— ç©·æ— å°½çš„ç­”æ¡ˆ (ç”¨ä»»ä½•è¯­è¨€!)
// @description:zh-TW   å¾žç„¡æ‰€ä¸çŸ¥çš„ ChatGPT ç”Ÿæˆç„¡çª®ç„¡ç›¡çš„ç­”æ¡ˆ (ç”¨ä»»ä½•èªžè¨€!)
// @author              Adam Lui
// @namespace           https://github.com/adamlui
// @license             MIT
// @match               https://chat.openai.com/*
// @icon                https://raw.githubusercontent.com/adamlui/chatgpt-infinity/main/media/images/icons/infinity-symbol/black/icon48.png
// @icon64              https://raw.githubusercontent.com/adamlui/chatgpt-infinity/main/media/images/icons/infinity-symbol/black/icon64.png
// @compatible          chrome
// @compatible          firefox
// @compatible          edge
// @compatible          opera
// @compatible          brave
// @compatible          vivaldi
// @compatible          waterfox
// @compatible          librewolf
// @compatible          ghost
// @compatible          qq
// @require             https://cdn.jsdelivr.net/gh/chatgptjs/chatgpt.js@abf4e7ea3ed450b9f34b045d73c9522be43b2c1c/dist/chatgpt-1.6.7.min.js
// @connect             raw.githubusercontent.com
// @grant               GM_setValue
// @grant               GM_getValue
// @grant               GM_registerMenuCommand
// @grant               GM_unregisterMenuCommand
// @grant               GM.xmlHttpRequest
// @noframes
// @updateURL           https://greasyfork.org/scripts/465051/code/chatgpt-infinity.meta.js
// @downloadURL         https://greasyfork.org/scripts/465051/code/chatgpt-infinity.user.js
// @homepageURL         https://chatgptevo.com/infinity
// @supportURL          https://chatgptevo.com/infinity/support
// ==/UserScript==

// NOTE: This script relies on the powerful chatgpt.js library @ https://chatgpt.js.org (c) 2023 KudoAI & contributors under the MIT license

(async () => {

    // Initialize settings
    var configKeyPrefix = 'chatGPTinf_'
    var config = { userLanguage: navigator.languages[0] || navigator.language || '', infinityMode: false }
    loadSetting('toggleHidden', 'autoScrollDisabled', 'replyLanguage', 'replyInterval')
    if (!config.replyLanguage) saveSetting('replyLanguage', navigator.languages[0] || navigator.language || '') // init reply language
    if (!config.replyInterval) saveSetting('replyInterval', 7) // init refresh interval to 7 secs if unset

    // Define messages
    var msgsLoaded = new Promise(resolve => {
        var msgHostDir = 'https://raw.githubusercontent.com/adamlui/chatgpt-infinity/main/greasemonkey/_locales/'
        var msgLocaleDir = ( config.userLanguage ? config.userLanguage.replace('-', '_') : 'en' ) + '/'
        var msgHref = msgHostDir + msgLocaleDir + 'messages.json' // build src link
        var msgXHRtries = 0
        GM.xmlHttpRequest({ method: 'GET', url: msgHref, onload: onLoad })
        function onLoad(response) {
            try { // to return localized messages.json
                var messages = new Proxy(JSON.parse(response.responseText), {
                    get(target, prop) { // remove need to ref nested keys
                        if (typeof target[prop] === 'object' && target[prop] !== null && 'message' in target[prop]) {
                            return target[prop].message
                }}}) ; resolve(messages)
            } catch (error) { // if 404
                msgXHRtries++ ; if (msgXHRtries == 3) return // try up to 3X (original/region-stripped/EN) only
                msgHref = config.userLanguage.includes('-') && msgXHRtries == 1 ? // if regional lang on 1st try...
                    msgHref.replace(/(.*)_.*(\/.*)/, '$1$2') // ...strip region before retrying
                        : ( msgHostDir + 'en/messages.json' ) // else use default English messages
                GM.xmlHttpRequest({ method: 'GET', url: msgHref, onload: onLoad })
            }
        }
    }) ; var messages = await msgsLoaded

    // Init/register menu
    var menuIDs = [], stateSymbol = ['âœ”ï¸', 'âŒ'], stateWord = ['ON', 'OFF'] // initialize menu vars
    registerMenu() // create browser toolbar menu

    await chatgpt.isLoaded()

    // Stylize toggle switch
    var switchStyle = document.createElement('style')
    switchStyle.innerHTML = `/* Stylize switch */
        .switch { position:absolute ; left:208px ; width:34px ; height:18px }
        .switch input { opacity:0 ; width:0 ; height:0 } /* hide checkbox */
        .slider { position:absolute ; cursor:pointer ; top:0 ; left:0 ; right:0 ; bottom:0 ; background-color:#ccc ; -webkit-transition:.4s ; transition:.4s ; border-radius:28px }
        .slider:before { position:absolute ; content:"" ; height:14px ; width:14px ; left:3px; bottom:2px ; background-color:white ; -webkit-transition:.4s ; transition:.4s ; border-radius:28px }

        /* Position/color ON-state */
        input:checked { position:absolute ; right:3px }
        input:checked + .slider { background-color:#42B4BF }
        input:checked + .slider:before {
            -webkit-transform: translateX(14px) translateY(1px) ;
            -ms-transform: translateX(14px) translateY(1px) ;
            transform: translateX(14px) }`

    document.head.appendChild(switchStyle)

    // Create toggle label, add listener/classes/HTML
    var toggleLabel = document.createElement('div') // create label div
    toggleLabel.addEventListener('click', function() {
        var toggleInput = document.querySelector('#infinityToggle')
        toggleInput.click() ; infinityMode.toggle()
    })
    for (var navLink of document.querySelectorAll('nav[aria-label="Chat history"] > a')) { // inspect sidebar for classes
        if (navLink.text.match(/.*chat/)) { // focus on new/clear chat button
            toggleLabel.setAttribute('class', navLink.classList) // borrow its classes
            break // stop looping since class assignment is done
        }
    } updateToggleHTML()

    // Insert full toggle on page load + during navigation // åœ¨å¯¼èˆªæœŸé—´æ’å…¥é¡µé¢åŠ è½½ + çš„å®Œæ•´åˆ‡æ¢
    insertToggle()
    var navObserver = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList' && mutation.addedNodes.length) {
                insertToggle()
    }})})
    navObserver.observe(document.documentElement, { childList: true, subtree: true })

    // Define SCRIPT functions

    function registerMenu() {
        menuIDs = [] // empty to store newly registered cmds for removal while preserving order
        var stateSeparator = getUserscriptManager() === 'Tampermonkey' ? ' â€” ' : ': '

        // Add command to toggle Infinity Mode
        var imLabel = stateSymbol[+!config.infinityMode] + ' ' + messages.menuLabel_infinityMode + ' âˆž '
            + stateSeparator + stateWord[+!config.infinityMode]
        menuIDs.push(GM_registerMenuCommand(imLabel, function() {
            document.querySelector('#infinityToggle').click()
        }))

        // Add command to toggle visibility of toggle
        var tvLabel = stateSymbol[+config.toggleHidden] + ' ' + messages.menuLabel_toggleVis
            + stateSeparator + stateWord[+config.toggleHidden]
        menuIDs.push(GM_registerMenuCommand(tvLabel, function() {
            saveSetting('toggleHidden', !config.toggleHidden)
            toggleLabel.style.display = config.toggleHidden ? 'none' : 'flex' // toggle visibility
            if (!config.notifHidden) {
                chatgpt.notify('âˆž ' + messages.menuLabel_toggleVis + ': '+ stateWord[+config.toggleHidden],
                    '', '', chatgpt.isDarkMode() ? '' : 'shadow')
            } for (var id of menuIDs) GM_unregisterMenuCommand(id) ; registerMenu() // refresh menu
        }))

        // Add command to toggle auto-scroll
        var asLabel = stateSymbol[+config.autoScrollDisabled] + ' ' + messages.menuLabel_autoScroll
            + stateSeparator + stateWord[+config.autoScrollDisabled]
        menuIDs.push(GM_registerMenuCommand(asLabel, function() {
            saveSetting('autoScrollDisabled', !config.autoScrollDisabled)
            if (!config.notifHidden) {
                chatgpt.notify('âˆž ' + messages.menuLabel_autoScroll + ': '+ stateWord[+config.autoScrollDisabled],
                    '', '', chatgpt.isDarkMode() ? '' : 'shadow')
            } for (var id of menuIDs) GM_unregisterMenuCommand(id) ; registerMenu() // refresh menu
        }))

        // Add command to set language
        var rlLabel = 'ðŸŒ ' + messages.menuLabel_replyLang + stateSeparator
                    + ( config.replyLanguage ? config.replyLanguage : 'English' )
        menuIDs.push(GM_registerMenuCommand(rlLabel, async function() {
            while (true) {
                var replyLanguage = prompt(`${ messages.prompt_updateReplyLang }:`, config.replyLanguage)
                if (replyLanguage === null) break // user cancelled so do nothing
                else if (!/\d/.test(replyLanguage)) {
                    saveSetting('replyLanguage', replyLanguage)
                    alert(`${ messages.alert_willReplyIn } ${ replyLanguage ? replyLanguage : messages.alerts.yourSysLang }.`)
                    if (config.infinityMode) { // restart session using new reply language
                        chatgpt.stop() ; infinityMode.deactivate() ; infinityMode.toggle() }
                    for (var id of menuIDs) GM_unregisterMenuCommand(id) ; registerMenu() // refresh menu
                    break
        }}}))

        // Add command to change reply interval
        var riLabel = 'âŒš ' + messages.menuLabel_replyInt + stateSeparator + config.replyInterval + 's'
        menuIDs.push(GM_registerMenuCommand(riLabel, async function() {
            while (true) {
                var replyInterval = prompt(`${ messages.prompt_updateReplyInt }:`, config.replyInterval)
                if (replyInterval === null) break // user cancelled so do nothing
                else if (!isNaN(parseInt(replyInterval)) && parseInt(replyInterval) > 4) { // valid int set
                    saveSetting('replyInterval', parseInt(replyInterval))
                    alert(`${ messages.alert_willReplyEvery } ${ replyInterval } ${ messages.unit_seconds }.`)
                    if (config.infinityMode) { // reset reply interval w/o ending session
                        clearTimeout(infinityMode.isActive) ; await chatgpt.isIdle()
                        if (config.infinityMode && !infinityMode.isActive) { // double-check in case de-activated before scheduled
                            infinityMode.isActive = setTimeout(infinityMode.continue, parseInt(config.replyInterval) * 1000)
                    }}
                    for (var id of menuIDs) GM_unregisterMenuCommand(id) ; registerMenu() // refresh menu
                    break
        }}}))
    }

    function getUserscriptManager() { try { return GM_info.scriptHandler } catch(error) { return 'other' }}

    function loadSetting(...keys) {
        keys.forEach(key => {
            config[key] = GM_getValue(configKeyPrefix + key, false)
    })}

    function saveSetting(key, value) {
        GM_setValue(configKeyPrefix + key, value) // save to browser
        config[key] = value // and memory
    }

    // Define TOGGLE functions

    function insertToggle() {
        var chatHistoryNav = document.querySelector('nav[aria-label="Chat history"]')
        var firstButton = chatHistoryNav.querySelector('a')
        if (chatgpt.history.isOff()) firstButton.nextElementSibling.style.display = 'none' // hide enable-history spam div
        if (!chatHistoryNav.contains(toggleLabel)) chatHistoryNav.insertBefore(toggleLabel, firstButton) // insert toggle
    }

    function updateToggleHTML() {
        toggleLabel.innerHTML = `
            <img width="18px" src="https://raw.githubusercontent.com/adamlui/chatgpt-infinity/main/media/images/icons/infinity-symbol/white/icon64.png">
            ${ messages.menuLabel_infinityMode } ${config.infinityMode ? messages.state_enabled : messages.state_disabled }
            <label class="switch" ><input id="infinityToggle" type="checkbox"
                ${ config.infinityMode ? 'checked="true"' : '' } >
                <span class="slider"></span></label>`
        toggleLabel.style.display = config.toggleHidden ? 'none' : 'flex'
    }

    var infinityMode = {

        activate: async function() {
            if (!config.notifHidden) {
                chatgpt.notify('âˆž ' + messages.menuLabel_infinityMode + ': ON', '', '', chatgpt.isDarkMode() ? '' : 'shadow')
            }
            document.querySelector('nav > a').click()
            setTimeout(function() {
                chatgpt.send('generate a single random q&a' + ( config.replyLanguage ? ( ' in ' + config.replyLanguage ) : ''  )
                                                            + '. don\'t type anything else') }, 500)
            infinityMode.sent = true ; await chatgpt.isIdle()
            if (config.infinityMode && !infinityMode.isActive) { // double-check in case de-activated before scheduled
                infinityMode.isActive = setTimeout(infinityMode.continue, parseInt(config.replyInterval) * 1000)
            }
        },

        continue: async function() {
            chatgpt.send('do it again')
            if (!config.autoScrollDisabled) try { chatgpt.scrollToBottom() } catch(error) {}
            await chatgpt.isIdle() // before starting delay till next iteration
            if (infinityMode.isActive) infinityMode.isActive = setTimeout(infinityMode.continue, parseInt(config.replyInterval) * 1000)
        },

        deactivate: function() {
            clearTimeout(infinityMode.isActive) ; infinityMode.isActive = null, infinityMode.sent = null
            if (!config.notifHidden) {
                chatgpt.notify('âˆž ' + messages.menuLabel_infinityMode + ': OFF', '', '', chatgpt.isDarkMode() ? '' : 'shadow')
            }
        },

        toggle: async function() {
            var toggleInput = document.querySelector('#infinityToggle')
            setTimeout(updateToggleHTML, 200) // sync label change w/ switch movement
            config.infinityMode = toggleInput.checked
            for (var id of menuID) { GM_unregisterMenuCommand(id) } registerMenu() // refresh menu 
            chatgpt.stop()
            if (config.infinityMode && !infinityMode.sent) infinityMode.activate()
            else if (!config.infinityMode && infinityMode.sent) infinityMode.deactivate()
        }
    }

})()
